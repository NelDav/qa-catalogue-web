<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://use.fontawesome.com/feff23b961.js"></script>
<style type="text/css">
#per-page .label {
    color: #999;
}
#query {
    border-radius: 10px;
    border-color: #37ba00;
}
#content {
    border-top: 1px solid #cccccc;
    border-radius: 10px;
}
h1 {
    color: #37ba00;
    padding: 5px;
    border-bottom: 1px solid #cccccc;
    border-radius: 10px;
    font-weight: 900;
}
h1 span {
    font-size: 80%;
    color: #333;
    font-weight: 100;
}
h3 {
    color: #37ba00;
}
.search-block {
    margin-bottom: 10px;
}
#message {
    color: #37ba00;
}
#navigation {
    border-bottom: 1px dashed #cccccc;
    margin-bottom: 15px;
}

#records {
    padding: 0;
    margin: 0;
    margin-top: 5px;
}
.record {
    margin-bottom: 15px;
}

.record h2 {
    margin-bottom: 0;
    font-weight: 200;
}
.record h2 .fa-book {
    color: #37ba00;
}

.record .label {
    color: #cccccc;
}
.record .details {
    display: none;
}
ul {
    list-style-type: none;
    padding-left: 0px;
}
#numFound {
    color: #37ba00;
    font-weight: 900;
}
#solr-url {
    overflow: auto;
    overflow-wrap: break-word;
    word-break: break-all;
    color: #37ba00;
    font-size: small;
}
</style>
</head>
<body>
<div class="container">
    <!-- Content here -->
    <h1><i class="fa fa-book" aria-hidden="true"></i> Tradit catalog <span>analysing clusters</span></h1>
    <div class="container" id="content">

        <div class="row">
            <div id="left" class="col-3">
                <div class="search-block">
                    <h3>Search</h3>
                    <form id="search">
                        <input type="text" name="query" id="query" value="*:*">
                        <i class="fa fa-search" aria-hidden="true"></i>
                    </form>
                </div>
                <div id="filters" class="filter-block">
                    <h3>Filters</h3>
                    <div id="filter-list"></div>
                </div>

                <div id="facets" class="facet-block">
                    <h3>Facets</h3>
                    <div id="facet-list"></div>
                </div>
            </div>
            <div id="main" class="col">
                <div class="row">
                    <div class="col-8">
                        Found <span id="numFound"></span> records
                    </div>
                    <div class="col-4" id="message"></div>
                </div>

                <div class="row" id="navigation">
                    <div class="col-8" id="prev-next"></div>
                    <div class="col-4" id="per-page">
                        <span class="label">Items per page:</span>
                        <span id="items-per-page"></span>
                    </div>
                </div>
                <div id="records"></div>
                <div id="solr-url"></div>
            </div>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
<script src="js/handlebars.min.js"></script>

<script id="list-facet-template" type="text/x-handlebars-template">
    <div id="{{machineName}}" class="facet-block">
        <h4>{{facetName}}</h4>
        {{#list facets}}<a href="#">{{term}}</a> ({{count}}){{/list}}
    </div>
</script>

<script id="record-template" type="text/x-handlebars-template">
    <div class="record">
        <h2>{{Title_mainTitle_ss}} <a href="#" data="details-{{id}}"><i class="fa fa-book" aria-hidden="true"></i></a></h2>
        {{Title_responsibilityStatement_ss}}<br/>
        {{Edition_editionStatement_ss}}<br/>
        {{Publication_place_ss}} {{Publication_agent_ss}} {{Publication_date_ss}}<br/>
        {{PhysicalDescription_extent_ss}} {{PhysicalDescription_dimensions_ss}}<br/>
        {{MainPersonalName_personalName_ss}} {{MainPersonalName_dates_ss}}<br/>
        <a href="#" class="record-link" data="Topic_topicalTerm_ss">{{Topic_topicalTerm_ss}}</a><br/>
        <a href="#" class="record-link" data="Topic_geographicSubdivision_ss">{{Topic_geographicSubdivision_ss}}</a><br/>
        <a href="#" class="record-link" data="Topic_formSubdivision_ss">{{Topic_formSubdivision_ss}}</a><br/>
        <div class="details" id="details-{{id}}">
            {{#list fields}}<span class="label">{{label}}:</span> {{value}}{{/list}}
        </div>
    </div>
</script>

<script id="filter-param-template" type="text/x-handlebars-template"
>fq={{field}}:"{{value}}"</script>

<script id="list-filters-template" type="text/x-handlebars-template">
{{#list filters}}<a href="#" data="{{param}}"><i class="fa fa-minus" aria-hidden="true"></i></a> {{label}}{{/list}}
</script>

<script id="item-prev-next-template" type="text/x-handlebars-template">
<a href="#" data="{{start}}">{{label}}</a>
</script>

<script id="list-prev-next-template" type="text/x-handlebars-template">
{{#list items}}{{item}}{{/list}}
</script>

<script id="strong-template" type="text/x-handlebars-template">
<strong>{{item}}</strong>
</script>

<script type="text/javascript">
  var baseUrl = 'http://localhost:8983/solr/tradit/select/';
  var query = '*:*';
  var start = 0;
  var rows = 10;
  var filters = [];
  var parameters = [
      'wt=json',
      'json.nl=map',
      'json.wrf=?',
      'facet=on',
      // 'facet.field=ManifestationIdentifier_ss',
      'facet.field=WorkIdentifier_ss',
      'facet.field=Language_ss',
      'facet.field=AdminMetadata_languageOfCataloging_ss',
      'facet.field=Leader_typeOfRecord_ss',
      'facet.field=GeneralInformation_festschrift_ss',
      'facet.field=Leader_descriptiveCatalogingForm_ss'
  ];

  var facetLabels = {
      'ManifestationIdentifier_ss': 'manifestations',
      'WorkIdentifier_ss': 'works',
      'Language_ss': 'language',
      'AdminMetadata_languageOfCataloging_ss': 'language of cataloging',
      'Leader_typeOfRecord_ss': 'record type',
      'GeneralInformation_festschrift_ss': 'festschrift',
      'Leader_descriptiveCatalogingForm_ss': 'cataloging form',
      'Topic_topicalTerm_ss': 'topic',
      'Topic_geographicSubdivision_ss': 'geographic',
      'Topic_formSubdivision_ss': 'form',
  };

  Handlebars.registerHelper('list', function(items, options) {
      var out = '<ul>';
      for(var i=0, l=items.length; i<l; i++) {
          out = out + '<li>' + options.fn(items[i]) + '</li>';
      }
      return out + '</ul>';
  });

  var recordTemplate      = Handlebars.compile($("#record-template").html());
  var listFacetTemplate   = Handlebars.compile($("#list-facet-template").html());
  var filterParamTemplate = Handlebars.compile($("#filter-param-template").html());
  var filterTemplate      = Handlebars.compile($("#list-filters-template").html());
  var prevNextTemplate    = Handlebars.compile($("#list-prev-next-template").html());
  var itemPrevNextTemplate= Handlebars.compile($("#item-prev-next-template").html());
  var strong              = Handlebars.compile($("#strong-template").html());

  function buildUrl() {
      var url = baseUrl
          + '?q=' + query
          + '&' + parameters.join('&')
          + '&start=' + start
          + '&rows=' + rows;

      if (filters.length > 0)
          for (var i = 0; i < filters.length; i++)
              url += '&' + filters[i].param;

      return url;
  }

  function updateFilterBlock() {
      $('#filter-list').html(filterTemplate({'filters': filters}));
      $('#filter-list a').click(function (e) {
          var filter = $(this).attr('data');
          var index = -1;
          for (var i = 0; i < filters.length; i++) {
              if (filters[i].param == filter) {
                  index = i;
                  break;
              }
          }
          if (index != -1) {
              filters.splice(index, 1);
              start = 0;
              loadUrl(buildUrl());
          }
      })
  };

  function createPrevNextLinks(numFound) {
      $('#prev-next').html('');
      var items = [];
      if (start > 0) {
          for (var i = 1; i <= 3; i++) {
              var item = start - (i * rows);
              if (item >= 0)
                  items.unshift(itemPrevNextTemplate(
                      {'start': item, 'label': getInterval(item, false)}));
          }
      }
      items.push(strong({'item': getInterval(start, true)}));
      for (var i = 1; i <= 3; i++) {
          var item = parseInt(start) + (i * rows);
          if (item+1 < numFound)
              items.push(itemPrevNextTemplate({'start': item, 'label': getInterval(item, false)}));
      }
      $('#prev-next').html(items.join(' &nbsp; '));
      $('#prev-next a').click(function (event) {
          event.preventDefault();
          start = $(this).attr('data');
          loadUrl(buildUrl());
      });
  }

  function getInterval(number, both) {
      var beginning = parseInt(number) + 1;
      var startEnd = beginning + '-';
      if (both === true) {
          var ending = parseInt(number) + parseInt(rows);
          startEnd += ending;
      }
      return startEnd;
  }

  function loadUrl(urlParam) {
      $('#message').html('<i class="fa fa-spinner" aria-hidden="true"></i> loading...');
      // console.log('loading url: ' + urlParam);

      if (filters.length > 0) {
          updateFilterBlock();
      } else {
          $('#filter-list').html('');
      }

      $.getJSON(urlParam, function(result, status) {
          // console.log('loaded url: ' + urlParam);
          // console.log('status: ' + status);
          $('#numFound').html(result.response.numFound.toLocaleString('en-US'));
          $('#solr-url').html(urlParam);

          var numFound = result.response.numFound;
          createPrevNextLinks(numFound);

          $('#records').html('');
          $('#facet-list').html('');

          for (var i = 0; i < result.response.docs.length; i++) {
              fields = [];
              for (var label in result.response.docs[i]) {
                  var value = result.response.docs[i][label];
                  if (Object.prototype.toString.call(value) === '[object Array]'
                      && value.length) {
                      value = value[0];
                  }

                  fields.push({'label': label, 'value': value});
              }
              context = result.response.docs[i];
              context.fields = fields;

              $('#records').append(recordTemplate(context));
          }
          showRecordDetails();

          for (var facetName in result.facet_counts.facet_fields) {
              context = {
                  'facetName': facetLabels[facetName],
                  'machineName': facetName,
                  'facets': []
              };
              for (var term in result.facet_counts.facet_fields[facetName]) {
                  var count = result.facet_counts.facet_fields[facetName][term];
                  if (count > 0)
                      context.facets.push({
                          'term': term,
                          'count': count //.toLocaleString('en-US')
                      });
              }
              if (facetName == 'ManifestationIdentifier_ss'
                  || facetName == 'WorkIdentifier_ss') {
                  context.facets.sort(function(a,b) {
                      return b.count - a.count;
                  });
              }

              $('#facet-list').append(listFacetTemplate(context));
          }

          $('div.facet-block ul a').click(function (e) {
              var field = $(this).parent().parent().parent().attr('id');
              var value = $(this).html();
              var filterParam = filterParamTemplate({'field': field, 'value': value});
              filters.push({
                  'param': filterParam,
                  'label': facetLabels[field] + ': ' + value
              });
              start = 0;
              loadUrl(buildUrl());
          });

          $('#message').html('');
      });
  }

  function showRecordDetails() {
      $('.record h2 a').click(function (event) {
          event.preventDefault();
          var detailsId = $(this).attr('data');
          console.log(detailsId);
          $('#' + detailsId).toggle();
      });

      $('.record-link').click(function (event) {
          event.preventDefault();
          var field = $(this).attr('data');
          var value = $(this).html();
          var filterParam = filterParamTemplate({'field': field, 'value': value});
          filters.push({
              'param': filterParam,
              'label': facetLabels[field] + ': ' + value
          });
          start = 0;
          loadUrl(buildUrl());
      });
  }

  function doSearch() {
      query = $('#query').val();
      start = 0;
      loadUrl(buildUrl());
  }

  function itemsPerPage() {
      var items = [];
      var numbers = [10, 25, 50, 100];
      for (var number in numbers) {
          if (numbers[number] == rows)
              items.push(strong({'item': numbers[number]}));
          else
              items.push(itemPrevNextTemplate({
                  'start': numbers[number], 'label': numbers[number]}));
      }
      $('#items-per-page').html(items.join(' '));
      $('#items-per-page a').click(function (event) {
          event.preventDefault();
          start = 0;
          rows = $(this).attr('data');
          itemsPerPage();
          loadUrl(buildUrl());
      });
  }

  $(document).ready(function () {
      itemsPerPage();

      $('.fa-search').click(function (event) {
          doSearch();
      });
      $('#search').submit(function (event) {
          event.preventDefault();
          doSearch();
      });
      loadUrl(buildUrl());
   });
</script>


</body>
</html>