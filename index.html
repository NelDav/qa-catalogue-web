<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://use.fontawesome.com/feff23b961.js"></script>
</head>
<body>
<div class="container">
    <!-- Content here -->
    <h1>Tradit catalog :: analysing clusters</h1>
    <div class="container">

        <div class="row">
            <div id="left" class="col-3">
                <div class="search-block">
                    <h3>Search</h3>
                    <form id="search">
                        <input type="text" name="query" id="query" value="*:*">
                        <i class="fa fa-search" aria-hidden="true"></i>
                    </form>
                </div>
                <div id="filters" class="filter-block">
                    <h3>Filters</h3>
                    <div id="filter-list"></div>
                </div>

                <div id="facets" class="facet-block">
                    <h3>Facets</h3>
                    <div id="facet-list"></div>
                </div>
            </div>
            <div id="main" class="col">
                <div>Found <span id="numFound"></span> records</div>
                <div id="records">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
<script src="js/handlebars.min.js"></script>

<script id="list-facet-template" type="text/x-handlebars-template">
    <div id="{{machineName}}" class="facet-block">
        <h4>{{facetName}}</h4>
        {{#list facets}}<a href="#">{{term}}</a> ({{count}}){{/list}}
    </div>
</script>

<script id="record-template" type="text/x-handlebars-template">
    <div class="record">
        <h2>{{Title_mainTitle_ss}}</h2>
        {{Publication_place_ss}} {{DatesOfPublication_ss}}
    </div>
</script>

<script id="filter-param-template" type="text/x-handlebars-template"
>fq={{field}}:"{{value}}"</script>

<script id="list-filters-template" type="text/x-handlebars-template">
{{#list filters}}<a href="#" data="{{param}}"><i class="fa fa-minus" aria-hidden="true"></i></a> {{label}}{{/list}}
</script>

<script type="text/javascript">
  var baseUrl = 'http://localhost:8983/solr/tradit/select/';
  var query = '*:*';
  var start = 0;
  var filters = [];
  var parameters = [
      'wt=json',
      'json.nl=map',
      'json.wrf=?',
      'facet=on',
      'facet.field=AdminMetadata_languageOfCataloging_ss',
      'facet.field=Leader_typeOfRecord_ss',
      'facet.field=GeneralInformation_festschrift_ss',
      'facet.field=Leader_descriptiveCatalogingForm_ss'
  ];

  var facetLabels = {
      'AdminMetadata_languageOfCataloging_ss': 'language',
      'Leader_typeOfRecord_ss': 'record type',
      'GeneralInformation_festschrift_ss': 'festschrift',
      'Leader_descriptiveCatalogingForm_ss': 'cataloging form'
  };

  Handlebars.registerHelper('list', function(items, options) {
      var out = '<ul>';
      for(var i=0, l=items.length; i<l; i++) {
          out = out + '<li>' + options.fn(items[i]) + '</li>';
      }
      return out + '</ul>';
  });

  var recordTemplate      = Handlebars.compile($("#record-template").html());
  var listFacetTemplate   = Handlebars.compile($("#list-facet-template").html());
  var filterParamTemplate = Handlebars.compile($("#filter-param-template").html());
  var filterTemplate      = Handlebars.compile($("#list-filters-template").html());

  function buildUrl() {
      var url = baseUrl + '?q=' + query
          + '&' + parameters.join('&');

      if (filters.length > 0)
          for (var i = 0; i < filters.length; i++)
              url += '&' + filters[i].param;

      return url;
  }

  function updateFilterBlock() {
      $('#filter-list').html(filterTemplate({'filters': filters}));
      $('#filter-list a').click(function (e) {
          var filter = $(this).attr('data');
          var index = -1;
          for (var i = 0; i < filters.length; i++) {
              if (filters[i].param == filter) {
                  index = i;
                  break;
              }
          }
          if (index != -1) {
              filters.splice(index, 1);
              loadUrl(buildUrl());
          }
      })
  };

  function loadUrl(urlParam) {
      // console.log('loading url: ' + urlParam);

      if (filters.length > 0) {
          updateFilterBlock();
      } else {
          $('#filter-list').html('');
      }

      $.getJSON(urlParam, function(result, status) {
          // console.log('loaded url: ' + urlParam);
          // console.log('status: ' + status);
          $('#numFound').html(result.response.numFound.toLocaleString('en-US'));

          $('#records').html('');
          $('#facet-list').html('');

          for (var i = 0; i < result.response.docs.length; i++) {
              $('#records').append(recordTemplate(result.response.docs[i]));
          }

          for (var facetName in result.facet_counts.facet_fields) {
              context = {
                  'facetName': facetLabels[facetName],
                  'machineName': facetName,
                  'facets': []
              };
              for (var term in result.facet_counts.facet_fields[facetName]) {
                  context.facets.push({
                      'term': term,
                      'count': result.facet_counts.facet_fields[facetName][term].toLocaleString('en-US')
                  });
              }
              $('#facet-list').append(listFacetTemplate(context));
          }

          $('div.facet-block ul a').click(function (e) {
              var field = $(this).parent().parent().parent().attr('id');
              var value = $(this).html();
              var filterParam = filterParamTemplate({'field': field, 'value': value});
              filters.push({
                  'param': filterParam,
                  'label': facetLabels[field] + ': ' + value
              });
              loadUrl(buildUrl());
          });
      });
  }

  function doSearch() {
      query = $('#query').val();
      loadUrl(buildUrl());
  }

  $(document).ready(function () {
      $('.fa-search').click(function (event) {
          doSearch();
      });
      $('#search').submit(function (event) {
          event.preventDefault();
          doSearch();
      });
      loadUrl(buildUrl());
   });
</script>


</body>
</html>